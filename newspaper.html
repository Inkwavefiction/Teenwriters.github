<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Teen Writers • Newspaper</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@500;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --sidebar-w: 320px;
      --bg: #0b0c0e;           /* dark to match sidebar */
      --panel: #101215;
      --ink: #e5e7eb;
      --muted: #9ca3af;
      --border: rgba(255,255,255,0.08);
      --accent: #22d3ee;
    }
    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: linear-gradient(135deg, #0b0c0e 0%, #0f1220 100%);
      color: var(--ink);
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      display:flex;
      min-height:100vh;
    }

    /* Layout */
    .shell{ display:flex; width:100%; }
    .sidebar-wrap{
      width: var(--sidebar-w);
      flex: 0 0 var(--sidebar-w);
      border-right: 1px solid var(--border);
      background: #0b0c0e;
      position: sticky; top:0; height:100vh;
    }
    .sidebar-frame{ width:100%; height:100%; border:0; }

    main{
      flex:1;
      min-width: 0;
      padding: clamp(16px, 2.5vw, 32px);
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .title{ font-size: clamp(22px, 2.2vw, 32px); font-weight:700; }
    .subtle{ color: var(--muted); font-size: .95rem; }

    /* Viewer panel */
    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow:hidden;
    }
    .panel-head{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 14px; border-bottom:1px solid var(--border);
    }
    .meta{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
      font-size:.95rem; color:var(--muted);
    }
    .btn{
      appearance:none; border:1px solid var(--border);
      background:#141821; color:var(--ink);
      padding:10px 14px; border-radius:12px; font-weight:600; cursor:pointer;
    }
    .btn:hover{ filter:brightness(1.08); }

    .viewer{
      background:#000; display:flex; align-items:center; justify-content:center;
      min-height: 70vh;
    }
    .viewer object,
    .viewer iframe,
    .viewer img,
    .viewer video{
      width:100%; height:80vh; max-height:82vh; border:0; display:block; object-fit:contain; background:#000;
    }

    /* Empty state */
    .empty{
      text-align:center; padding:56px 18px;
    }
    .empty-title{ font-size: clamp(18px, 1.8vw, 22px); font-weight:700; margin-bottom:6px; }
    .empty-note{ color:var(--muted); margin-bottom:18px; }
    .small{ font-size:.9rem; color:var(--muted); }

    @media (max-width: 860px){
      .sidebar-wrap{ display:none; }
      main{ padding: 18px; }
    }
  </style>
</head>
<body>
  <div class="shell">
    <!-- Left: your reusable sidebar -->
    <aside class="sidebar-wrap">
      <iframe class="sidebar-frame" src="sidebar.html" title="Sidebar"></iframe>
    </aside>

    <!-- Right: read-only Newspaper viewer -->
    <main>
      <header class="header">
        <h1 class="title">Newspaper</h1>
        <div class="subtle" id="status">Loading latest issue…</div>
      </header>

      <section class="panel" id="panel" hidden>
        <div class="panel-head">
          <div class="meta">
            <strong id="issue-title" style="color:#fff;"></strong>
            <span id="updated"></span>
          </div>
          <div class="actions">
            <a id="open-link" class="btn" href="#" target="_blank" rel="noopener">Open in new tab</a>
            <button class="btn" id="reload">Reload</button>
          </div>
        </div>
        <div class="viewer" id="viewer"></div>
      </section>

      <section class="panel" id="empty-panel">
        <div class="empty">
          <div class="empty-title">No newspaper available (yet).</div>
          <div class="empty-note">If you’re not seeing anything, the editors haven’t published an issue to this feed.</div>
          <button class="btn" id="try-again">Check again</button>
          <div class="small" style="margin-top:10px;">
            This page is view-only. Uploading happens on a separate, private page.
          </div>
        </div>
      </section>
    </main>
  </div>

  <script>
    // Where we look for metadata published by the (hidden) editor/uploader page.
    // Provide multiple candidates so it works on GitHub Pages or a /newspaper/ subfolder.
    const CANDIDATE_FEEDS = [
      'latest.json',
      './latest.json',
      '/newspaper/latest.json',
      '/news/latest.json'
    ];

    const statusEl = document.getElementById('status');
    const panel = document.getElementById('panel');
    const emptyPanel = document.getElementById('empty-panel');
    const viewer = document.getElementById('viewer');
    const issueTitle = document.getElementById('issue-title');
    const updatedEl = document.getElementById('updated');
    const openLink = document.getElementById('open-link');
    const reloadBtn = document.getElementById('reload');
    const tryAgain = document.getElementById('try-again');

    reloadBtn.addEventListener('click', loadLatest);
    tryAgain.addEventListener('click', loadLatest);

    function fmtDate(iso){
      try{
        const d = new Date(iso);
        if(isNaN(d.getTime())) return '';
        return '• Updated ' + d.toLocaleString();
      }catch{ return ''; }
    }

    function inferType(url){
      const u = (url || '').toLowerCase();
      if (u.endsWith('.pdf')) return 'pdf';
      if (u.match(/\.(png|jpg|jpeg|gif|webp|avif)$/)) return 'image';
      if (u.match(/\.(mp4|webm|mov|m4v)$/)) return 'video';
      return 'unknown';
    }

    async function fetchFirstJson(urls){
      for (const u of urls){
        try{
          const res = await fetch(u, { cache: 'no-store' });
          if(res.ok){
            const data = await res.json();
            return { data, url: u };
          }
        }catch(_e){}
      }
      return null;
    }

    function renderEmpty(reason){
      statusEl.textContent = reason || 'No issue found.';
      panel.hidden = true;
      emptyPanel.hidden = false;
      viewer.innerHTML = '';
    }

    function renderIssue(meta){
      const { title, src, type, updated_at } = meta || {};
      if(!src){
        renderEmpty('Nothing published yet.');
        return;
      }

      const kind = type || inferType(src);

      // Header
      issueTitle.textContent = title || 'Latest Issue';
      updatedEl.textContent = fmtDate(updated_at);
      openLink.href = src;

      // Body
      viewer.innerHTML = '';
      let node;

      if (kind === 'pdf'){
        // object -> better PDF support; provides fallback link if viewer blocked
        node = document.createElement('object');
        node.type = 'application/pdf';
        node.data = src;
        const fallback = document.createElement('div');
        fallback.style.padding = '18px';
        fallback.innerHTML = `
          <p>Can’t preview the PDF here. <a href="${src}" target="_blank" rel="noopener">Open in a new tab</a>.</p>
        `;
        node.appendChild(fallback);
      } else if (kind === 'image'){
        node = document.createElement('img');
        node.src = src;
        node.alt = title || 'Newspaper';
      } else if (kind === 'video'){
        node = document.createElement('video');
        node.src = src;
        node.controls = true;
      } else {
        // Unknown: show a simple link
        const link = document.createElement('a');
        link.href = src;
        link.target = '_blank';
        link.rel = 'noopener';
        link.textContent = 'Open newspaper';
        link.style.padding = '18px';
        node = link;
      }

      viewer.appendChild(node);

      // Show panel
      emptyPanel.hidden = true;
      panel.hidden = false;
      statusEl.textContent = 'Loaded.';
    }

    async function loadLatest(){
      statusEl.textContent = 'Loading latest issue…';
      try{
        // Allow override via query ?src=... for quick manual testing
        const params = new URLSearchParams(location.search);
        const directSrc = params.get('src');
        if(directSrc){
          renderIssue({ title: 'Preview', src: directSrc });
          return;
        }

        const found = await fetchFirstJson(CANDIDATE_FEEDS);
        if(!found || !found.data){
          renderEmpty('No newspaper available right now.');
          return;
        }

        // expected JSON shape:
        // { "title": "May Issue", "src": "https://.../issue.pdf", "type": "pdf|image|video", "updated_at": "2025-09-10T12:00:00Z" }
        renderIssue(found.data);
      }catch(e){
        console.error(e);
        renderEmpty('Couldn’t load the newspaper.');
      }
    }

    loadLatest();
  </script>
</body>
</html>
