<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Main Hallway — Team Writers Hub (Firestore-only)</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --sky-50:#eaf3ff; --sky-100:#e3f2fd; --sky-200:#cfe8ff;
      --sky-600:#1e88e5; --sky-700:#1976d2;
      --ink:#0f172a; --muted:#64748b; --chip:#eef6ff;
      --shadow:0 10px 26px rgba(2, 32, 71, .12);
    }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink);display:flex;background:var(--sky-50)}
    #sidebar-container{width:260px;flex:0 0 260px}
    .app{flex:1;min-width:0;max-height:100vh;display:grid;grid-template-rows:auto 1fr auto}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;background:#fff;border-bottom:1px solid var(--sky-200);position:sticky;top:0;z-index:5}
    header h1{margin:0;font-size:22px;font-weight:700;color:#0b305b}
    .pill{margin-left:auto;background:var(--chip);padding:6px 10px;border-radius:999px;font-weight:700;color:#195d9b;font-size:12px}
    .stream{overflow:auto;padding:18px;display:flex;flex-direction:column;gap:14px}
    .card{background:#fff;border:1px solid var(--sky-200);border-radius:16px;box-shadow:var(--shadow);display:grid;grid-template-columns:auto 1fr;gap:14px;padding:14px 16px}
    .avatar{width:40px;height:40px;border-radius:50%;display:grid;place-items:center;background:var(--sky-100);color:#195d9b;font-weight:800;border:1px solid var(--sky-200)}
    .msg{display:flex;flex-direction:column;gap:8px;min-width:0}
    .meta{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted)}
    .body{white-space:pre-wrap;word-wrap:break-word;line-height:1.5}
    .body a{color:var(--sky-700);text-decoration:underline;word-break:break-word}
    .attachments{display:flex;flex-wrap:wrap;gap:10px}
    .thumb{width:200px;max-width:42vw;height:130px;overflow:hidden;border-radius:12px;border:1px solid var(--sky-200);background:var(--sky-100)}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .link-card{min-width:260px;max-width:520px;display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:12px;background:var(--sky-100);border:1px solid var(--sky-200)}
    .link-card img{width:16px;height:16px;border-radius:4px}
    .actions{margin-left:auto;display:flex;gap:8px}
    .icon-btn{background:#fff;border:1px solid var(--sky-200);border-radius:10px;color:#143a6b;padding:6px 10px;cursor:pointer}
    .icon-btn:hover{background:var(--chip)}
    .composer{background:#fff;border-top:1px solid var(--sky-200);padding:14px 16px;display:grid;grid-template-columns:1fr auto;gap:12px}
    .inputs{display:grid;grid-template-rows:auto auto auto;gap:10px}
    textarea{width:100%;min-height:64px;max-height:200px;resize:vertical;background:var(--sky-100);border:1px solid var(--sky-200);border-radius:12px;padding:12px;font-size:14px;color:var(--ink);outline:none}
    input[type="url"]{width:100%;height:40px;background:var(--sky-100);border:1px solid var(--sky-200);border-radius:12px;padding:0 12px;font-size:14px;outline:none}
    .btn{height:40px;padding:0 16px;border:none;border-radius:12px;font-weight:800;cursor:pointer}
    .btn-ghost{background:var(--sky-100);border:1px solid var(--sky-200);color:#0b305b}
    .btn-ghost:hover{background:#fff}
    .btn-send{background:var(--sky-700);color:#fff}
    .btn-send:hover{background:#1558b5}
    .previews{display:flex;gap:10px;flex-wrap:wrap}
    .chip{background:var(--chip);border:1px solid var(--sky-200);padding:6px 8px;border-radius:10px;font-size:12px;display:flex;gap:8px;align-items:center}
    .chip button{border:none;background:transparent;color:#0b305b;cursor:pointer}
    .drop{border:2px dashed var(--sky-200);border-radius:12px;padding:10px;text-align:center;color:var(--muted);transition:all .15s ease;background:var(--sky-100)}
    .drop.dragging{background:#fff;color:#113d6e}
    @media (max-width:900px){#sidebar-container{display:none}}
  </style>
</head>
<body>
  <div id="sidebar-container"></div>

  <div class="app">
    <header>
      <h1>Main Hallway</h1>
      <span id="user-pill" class="pill">Anonymous</span>
    </header>

    <section id="stream" class="stream" aria-live="polite"></section>

    <form id="composer" class="composer" autocomplete="off">
      <div class="inputs">
        <textarea id="text" placeholder="Announce something to the hallway… (Shift+Enter = new line)"></textarea>
        <div style="display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center">
          <input id="linkInput" type="url" placeholder="Paste a link (https://…)"/>
          <label for="file" class="btn btn-ghost" title="Add images">+ Images</label>
          <input id="file" type="file" accept="image/*" multiple hidden>
        </div>
        <div id="drop" class="drop">Drag & drop images or links here</div>
        <div class="previews" id="previews"></div>
      </div>
      <div><button id="sendBtn" class="btn btn-send" type="submit">Post</button></div>
    </form>
  </div>

  <!-- App (Firestore-only) -->
  <script type="module">
    // Load shared sidebar
    (function(){ const c=document.getElementById("sidebar-container"); fetch("sidebar.html").then(r=>r.text()).then(h=>c.innerHTML=h).catch(()=>{}); })();

    // Firebase modular CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInAnonymously, updateProfile } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp, getCountFromServer, limit, getDocs, doc, deleteDoc, where, writeBatch, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
    import { getAnalytics, isSupported } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-analytics.js";

    // Your config (fixed storageBucket not used here)
    const firebaseConfig = {
      apiKey: "AIzaSyBDeZs6lkIcQ5rECCDvoSzNPYFQTYMvU2E",
      authDomain: "teenwriters-262d6.firebaseapp.com",
      projectId: "teenwriters-262d6",
      storageBucket: "teenwriters-262d6.appspot.com",
      messagingSenderId: "783661524936",
      appId: "1:783661524936:web:db2b81554e24c5c09e42fd",
      measurementId: "G-51B5VFVV2D"
    };

    const app = initializeApp(firebaseConfig);
    isSupported().then(s => { if (s) getAnalytics(app); });

    const auth = getAuth(app);
    const db   = getFirestore(app);

    // Simple identity
    const userPill = document.getElementById("user-pill");
    onAuthStateChanged(auth, async (u) => {
      if (!u) { await signInAnonymously(auth); return; }
      const localName = localStorage.getItem("twh_displayName");
      if (localName && !u.displayName) { try { await updateProfile(u, { displayName: localName }); } catch {} }
      userPill.textContent = u.displayName || "Anonymous";
    });

    // Collection + limits
    const COL = collection(db, "hallwayMessages");
    const MAX_MESSAGES = 500;           // keep newest 500
    const MAX_IMAGES_PER_MSG = 3;       // safety
    const MAX_DOC_BYTES = 900 * 1024;   // stay under Firestore 1MB cap
    const MAX_IMAGE_KB = 220;           // target per image after compression

    // DOM
    const stream = document.getElementById("stream");
    const form   = document.getElementById("composer");
    const textEl = document.getElementById("text");
    const fileEl = document.getElementById("file");
    const drop   = document.getElementById("drop");
    const previews = document.getElementById("previews");
    const linkInput = document.getElementById("linkInput");

    // Pending state
    const pending = { links: [], images: [] }; // images: File[]

    // Helpers
    function escapeHtml(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function autoLink(s){ const urlRe=/(https?:\/\/[^\s)]+)(?![^<]*>)/g; return escapeHtml(s).replace(urlRe,'<a href="$1" target="_blank" rel="noopener">$1</a>'); }
    function fav(u){ try{ return "https://www.google.com/s2/favicons?domain=" + new URL(u).hostname; }catch{ return ""; } }
    function byteEstimateFromB64(b64){ return Math.floor((b64.length * 3) / 4); } // rough

    // Image compression to dataURL <= MAX_IMAGE_KB
    async function fileToCappedDataUrl(file, maxW=1200, maxKB=MAX_IMAGE_KB){
      const img = await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=e=>{ const im=new Image(); im.onload=()=>res(im); im.onerror=rej; im.src=e.target.result; }; r.onerror=rej; r.readAsDataURL(file); });
      const scale = Math.min(1, maxW / img.naturalWidth || 1);
      const w = Math.round((img.naturalWidth||maxW) * scale);
      const h = Math.round((img.naturalHeight||maxW) * scale);
      const canvas = document.createElement("canvas");
      canvas.width = w; canvas.height = h;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, w, h);

      let q = 0.85, data = canvas.toDataURL("image/jpeg", q);
      const cap = maxKB * 1024;
      // reduce quality until under cap or min q
      while (byteEstimateFromB64(data.split(",")[1]||"") > cap && q > 0.4){
        q -= 0.1;
        data = canvas.toDataURL("image/jpeg", q);
      }
      return data;
    }

    // Realtime render
    const qStream = query(COL, orderBy("createdAt","asc"), limit(MAX_MESSAGES));
    onSnapshot(qStream, (snap)=>{
      stream.innerHTML = "";
      snap.forEach(docSnap=>{
        const m = docSnap.data(); const id=docSnap.id;
        const card = document.createElement("article"); card.className="card";
        const avatar = document.createElement("div"); avatar.className="avatar"; avatar.textContent=(m.author||"U").slice(0,1).toUpperCase();
        const msg = document.createElement("div"); msg.className="msg";
        const meta = document.createElement("div"); meta.className="meta";
        const time = m.createdAt?.toDate ? m.createdAt.toDate().toLocaleString() : "sending…";
        meta.innerHTML = `<strong>${escapeHtml(m.author||"Unknown")}</strong><span>•</span><span>${time}</span>`;
        const body = document.createElement("div"); body.className="body"; body.innerHTML = autoLink(m.text||"");

        const atts = document.createElement("div"); atts.className="attachments";
        (m.links||[]).forEach(url=>{ const a=document.createElement("a"); a.className="link-card"; a.href=url; a.target="_blank"; a.rel="noopener";
          const ico=document.createElement("img"); ico.src=fav(url); ico.alt="";
          const span=document.createElement("span"); span.style.overflow="hidden"; span.style.whiteSpace="nowrap"; span.style.textOverflow="ellipsis"; span.textContent=url;
          a.appendChild(ico); a.appendChild(span); atts.appendChild(a);
        });
        (m.images||[]).forEach(src=>{ const t=document.createElement("a"); t.className="thumb"; t.href=src; t.target="_blank"; t.rel="noopener";
          const img=document.createElement("img"); img.src=src; img.alt="Image"; t.appendChild(img); atts.appendChild(t);
        });

        const rowTop=document.createElement("div"); rowTop.style.display="flex"; rowTop.style.alignItems="center"; rowTop.style.gap="8px";
        rowTop.appendChild(meta);
        const actions=document.createElement("div"); actions.className="actions";
        const del=document.createElement("button"); del.className="icon-btn"; del.textContent="Delete";
        del.addEventListener("click", async ()=>{ const u=auth.currentUser; if(!u || u.uid!==m.uid) return; await deleteDoc(doc(db,"hallwayMessages",id)); });
        actions.appendChild(del); rowTop.appendChild(actions);
        onAuthStateChanged(auth, u=>{ actions.style.display = (u && u.uid===m.uid) ? "flex":"none"; });

        msg.appendChild(rowTop);
        if((m.text||"").trim()) msg.appendChild(body);
        if(atts.children.length) msg.appendChild(atts);

        card.appendChild(avatar); card.appendChild(msg); stream.appendChild(card);
      });
      stream.scrollTop = stream.scrollHeight;
    });

    // Previews
    function refreshPreviews(){
      previews.innerHTML="";
      pending.links.forEach((u,i)=>{ const chip=document.createElement("div"); chip.className="chip";
        chip.innerHTML=`<img src="${fav(u)}" alt="" style="width:14px;height:14px;border-radius:3px"> <span>${u}</span>`;
        const x=document.createElement("button"); x.textContent="✕"; x.onclick=()=>{ pending.links.splice(i,1); refreshPreviews(); };
        chip.appendChild(x); previews.appendChild(chip);
      });
      pending.images.forEach((f,i)=>{ const chip=document.createElement("div"); chip.className="chip"; chip.innerHTML=`<span>${f.name||('Image '+(i+1))}</span>`;
        const x=document.createElement("button"); x.textContent="✕"; x.onclick=()=>{ pending.images.splice(i,1); refreshPreviews(); };
        chip.appendChild(x); previews.appendChild(chip);
      });
    }

    linkInput.addEventListener("change", ()=>{
      const v=(linkInput.value||"").trim(); try{ const u=new URL(v); if(/^https?:$/.test(u.protocol)){ pending.links.push(u.toString()); refreshPreviews(); } }catch(_){}
      linkInput.value="";
    });
    fileEl.addEventListener("change", e=>{ [...e.target.files].forEach(f=>{ if(f.type.startsWith("image/")) pending.images.push(f); }); refreshPreviews(); fileEl.value=""; });

    // Drag & drop
    ["dragover","dragenter"].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add("dragging"); }));
    ["dragleave","drop"].forEach(ev=> drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove("dragging"); }));
    drop.addEventListener("drop", e=>{
      const files=[...(e.dataTransfer.files||[])]; files.forEach(f=>{ if(f.type.startsWith("image/")) pending.images.push(f); });
      const txt = e.dataTransfer.getData("text/uri-list") || e.dataTransfer.getData("text/plain");
      if(txt){ (txt.match(/https?:\/\/\S+/g)||[]).forEach(u=>{ try{ const v=new URL(u); if(/^https?:$/.test(v.protocol)) pending.links.push(v.toString()); }catch(_){}}); }
      refreshPreviews();
    });

    // Send message (images inline as dataURL)
    form.addEventListener("submit", async (e)=>{
      e.preventDefault();
      const u = auth.currentUser; if(!u){ alert("Not signed in yet. Try again."); return; }

      // compress images and enforce caps
      const files = pending.images.slice(0, MAX_IMAGES_PER_MSG);
      const dataUrls = [];
      for (const f of files){
        const d = await fileToCappedDataUrl(f);
        dataUrls.push(d);
      }

      // Ensure document size stays under cap
      const textVal = (textEl.value||"").trim();
      const textBytes = new Blob([textVal]).size;
      let totalBytes = textBytes;
      for (const d of dataUrls){ totalBytes += byteEstimateFromB64((d.split(",")[1])||""); }
      // If too large, drop images from the end until safe
      while (totalBytes > MAX_DOC_BYTES && dataUrls.length){
        const removed = dataUrls.pop();
        totalBytes -= byteEstimateFromB64((removed.split(",")[1])||"");
      }

      const links = pending.links.map(String);
      const shell = await addDoc(COL, {
        uid: u.uid,
        author: u.displayName || "Anonymous",
        text: textVal,
        links,
        images: dataUrls,          // stored inline
        createdAt: serverTimestamp()
      });

      // reset local inputs
      textEl.value=""; pending.links=[]; pending.images=[]; refreshPreviews();

      // prune if over cap
      await enforceCap();
    });

    async function enforceCap(){
      const countSnap = await getCountFromServer(COL);
      const total = countSnap.data().count || 0;
      if (total <= MAX_MESSAGES) return;
      const toDelete = total - MAX_MESSAGES;
      const oldQ = query(COL, orderBy("createdAt","asc"), limit(toDelete));
      const oldSnap = await getDocs(oldQ);
      const wb = writeBatch(db);
      oldSnap.forEach(d=> wb.delete(d.ref));
      await wb.commit();
    }

    // Optional: TTL deletion by age (set days>0 to enable)
    const TTL_DAYS = 0;
    window.addEventListener("load", async ()=>{
      if (TTL_DAYS > 0){
        const cutoff = new Date(Date.now() - TTL_DAYS*24*60*60*1000);
        const qOld = query(COL, where("createdAt","<", cutoff), orderBy("createdAt","asc"), limit(100));
        const snap = await getDocs(qOld);
        if (!snap.empty){ const wb = writeBatch(db); snap.forEach(d=> wb.delete(d.ref)); await wb.commit(); }
      }
    });

    // Smooth “Enter to post”
    document.addEventListener("keydown", (e)=>{
      if (document.activeElement === textEl && e.key==="Enter" && !e.shiftKey){
        e.preventDefault(); document.getElementById("sendBtn").click();
      }
    });
  </script>
</body>
</html>
