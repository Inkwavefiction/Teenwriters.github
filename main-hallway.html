<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Main Hallway — Team Writers Hub</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg1:#0ea5a4; /* default teal -> will be overridden by theme */
      --bg2:#2563eb;
      --panel:rgba(15,23,42,.35);
      --panel-2:rgba(255,255,255,.06);
      --text:#e5e7eb;
      --muted:#a8b3cf;
      --ink:#0f172a;
      --ring:rgba(255,255,255,.2);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:"Poppins",system-ui,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--text);
      display:flex;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
    }
    /* Layout */
    #sidebar-container{width:260px;flex:0 0 260px}
    .app{
      flex:1;min-width:0;max-height:100vh;
      display:grid;grid-template-rows:auto 1fr auto;
      backdrop-filter:saturate(120%);
    }
    header{
      display:flex;align-items:center;gap:12px;
      padding:16px 20px;background:var(--panel);
      border-bottom:1px solid rgba(255,255,255,.08);
    }
    header h1{margin:0;font-size:22px;font-weight:700}
    .pill{
      margin-left:auto;font-size:12px;font-weight:700;
      background:rgba(255,255,255,.12);padding:6px 10px;border-radius:999px
    }
    /* Message list */
    .stream{
      overflow:auto;padding:18px 20px 8px;display:flex;flex-direction:column;gap:12px
    }
    .card{
      align-self:flex-start;max-width:min(780px,100%);
      background:var(--panel);border:1px solid rgba(255,255,255,.08);
      border-radius:16px;box-shadow:0 10px 26px rgba(0,0,0,.18);
      display:grid;grid-template-columns:auto 1fr;gap:12px;padding:14px
    }
    .card.me{align-self:flex-end;background:rgba(255,255,255,.12)}
    .avatar{
      width:40px;height:40px;border-radius:50%;display:grid;place-items:center;
      background:var(--panel-2);border:1px solid rgba(255,255,255,.14);font-weight:700
    }
    .msg{
      display:flex;flex-direction:column;gap:8px;min-width:0
    }
    .meta{display:flex;gap:10px;align-items:center;font-size:12px;color:var(--muted)}
    .body{white-space:pre-wrap;word-wrap:break-word;line-height:1.4}
    .body a{color:#fff;text-decoration:underline}
    .attachments{display:flex;flex-wrap:wrap;gap:8px}
    .thumb{
      width:160px;height:100px;overflow:hidden;border-radius:12px;
      border:1px solid rgba(255,255,255,.1);background:rgba(255,255,255,.06)
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .link-card{
      min-width:260px;max-width:420px;display:flex;align-items:center;gap:10px;
      padding:10px 12px;border-radius:12px;background:rgba(255,255,255,.08);
      border:1px solid rgba(255,255,255,.14)
    }
    .link-card img{width:16px;height:16px;border-radius:4px}
    .actions{margin-left:auto;display:flex;gap:8px}
    .icon-btn{
      background:transparent;border:1px solid rgba(255,255,255,.18);
      border-radius:10px;color:var(--text);padding:6px 8px;cursor:pointer
    }
    .icon-btn:hover{background:rgba(255,255,255,.08)}
    /* Composer */
    .composer{
      display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px 16px;
      background:var(--panel);border-top:1px solid rgba(255,255,255,.08)
    }
    .inputs{
      display:grid;grid-template-rows:auto auto;gap:10px
    }
    .field{
      display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center
    }
    textarea{
      width:100%;min-height:64px;max-height:200px;resize:vertical;
      background:rgba(255,255,255,.08);color:var(--text);
      border:1px solid var(--ring);border-radius:12px;padding:12px;font-size:14px;outline:none
    }
    input[type="url"]{
      width:100%;height:40px;background:rgba(255,255,255,.08);color:var(--text);
      border:1px solid var(--ring);border-radius:12px;padding:0 12px;font-size:14px;outline:none
    }
    .btn{
      height:40px;padding:0 14px;border:none;border-radius:12px;font-weight:700;cursor:pointer
    }
    .btn-ghost{background:rgba(255,255,255,.08);color:var(--text);border:1px solid var(--ring)}
    .btn-ghost:hover{background:rgba(255,255,255,.14)}
    .btn-send{background:#fff;color:var(--ink)}
    .btn-send:hover{filter:brightness(.96)}
    .previews{display:flex;gap:10px;flex-wrap:wrap}
    .chip{
      background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.18);
      padding:6px 8px;border-radius:10px;font-size:12px;display:flex;gap:8px;align-items:center
    }
    .chip button{border:none;background:transparent;color:#fff;cursor:pointer}
    /* Drop zone */
    .drop{
      border:2px dashed rgba(255,255,255,.22);
      border-radius:12px;padding:10px;text-align:center;color:var(--muted);
      transition:all .15s ease
    }
    .drop.dragging{background:rgba(255,255,255,.08);color:#fff}
    /* Responsive */
    @media(max-width:900px){
      #sidebar-container{display:none}
      .app{grid-template-rows:auto 1fr auto}
    }
  </style>
</head>
<body>
  <!-- Shared Sidebar -->
  <div id="sidebar-container"></div>

  <!-- App -->
  <div class="app">
    <header>
      <h1>Main Hallway</h1>
      <span class="pill" id="theme-pill">Theme: Teal</span>
    </header>

    <!-- Messages -->
    <section id="stream" class="stream" aria-live="polite"></section>

    <!-- Composer -->
    <form id="composer" class="composer" autocomplete="off">
      <div class="inputs">
        <div class="field">
          <textarea id="text" placeholder="Say something inspiring… (Shift+Enter = newline)"></textarea>
          <label for="file" class="btn btn-ghost" title="Add images">+ Images</label>
          <input id="file" type="file" accept="image/*" multiple hidden>
          <button type="button" id="addLinkBtn" class="btn btn-ghost" title="Attach link">+ Link</button>
        </div>
        <div id="linkRow" class="field" style="display:none">
          <input id="linkInput" type="url" placeholder="Paste a link (https://…)">
          <button type="button" id="attachLink" class="btn btn-ghost">Attach</button>
          <button type="button" id="cancelLink" class="btn btn-ghost">Cancel</button>
        </div>
        <div id="drop" class="drop">Drag & drop images or links here</div>
        <div class="previews" id="previews"></div>
      </div>
      <div>
        <button class="btn btn-send" id="sendBtn" type="submit">Send</button>
      </div>
    </form>
  </div>

  <script>
    // ---------- Theme from sidebar selection ----------
    (function applyTheme(){
      const theme = localStorage.getItem("theme") || "teal";
      const pill = document.getElementById("theme-pill");
      const colors = {
        teal:["#0ea5a4","#2563eb"],
        blue:["#2563eb","#1e40af"],
        green:["#16a34a","#0ea5a4"],
        purple:["#7e22ce","#2563eb"],
      };
      const pair = colors[theme] || colors.teal;
      document.documentElement.style.setProperty("--bg1", pair[0]);
      document.documentElement.style.setProperty("--bg2", pair[1]);
      pill.textContent = "Theme: " + theme[0].toUpperCase()+theme.slice(1);
    })();

    // ---------- Sidebar loader ----------
    (function loadSidebar(){
      const c = document.getElementById("sidebar-container");
      fetch("sidebar.html").then(r=>r.text()).then(html=>c.innerHTML=html).catch(()=>{});
    })();

    // ---------- Storage ----------
    const KEY="twh_hallway_messages_v1";
    const me = JSON.parse(localStorage.getItem("twh_profile") || '{"name":"You"}');

    function getAll(){
      try{ return JSON.parse(localStorage.getItem(KEY) || "[]"); }
      catch{ return []; }
    }
    function saveAll(items){
      localStorage.setItem(KEY, JSON.stringify(items));
    }

    // ---------- Utils ----------
    function escapeHtml(s){
      return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }
    function autoLink(s){
      const urlRe = /(https?:\/\/[^\s)]+)(?![^<]*>)/g;
      return escapeHtml(s).replace(urlRe, '<a href="$1" target="_blank" rel="noopener">$1</a>');
    }
    function timeStr(t){
      const d=new Date(t);
      return d.toLocaleString();
    }

    // Resize images to keep storage reasonable (maxW 1200)
    function readAndMaybeResize(file, maxW=1200){
      return new Promise((resolve,reject)=>{
        const img = new Image();
        const reader = new FileReader();
        reader.onload = e => {
          img.onload = () => {
            const {width, height} = img;
            if(width <= maxW){
              resolve(e.target.result); // original dataURL
              return;
            }
            const ratio = maxW / width;
            const canvas = document.createElement("canvas");
            canvas.width = maxW;
            canvas.height = Math.round(height * ratio);
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            resolve(canvas.toDataURL("image/jpeg", 0.9));
          };
          img.onerror = reject;
          img.src = e.target.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    // ---------- State for new message ----------
    const pending = { text:"", links:[], images:[] };

    // ---------- DOM ----------
    const stream = document.getElementById("stream");
    const form = document.getElementById("composer");
    const text = document.getElementById("text");
    const file = document.getElementById("file");
    const drop = document.getElementById("drop");
    const previews = document.getElementById("previews");

    const linkRow = document.getElementById("linkRow");
    const addLinkBtn = document.getElementById("addLinkBtn");
    const linkInput = document.getElementById("linkInput");
    const attachLink = document.getElementById("attachLink");
    const cancelLink = document.getElementById("cancelLink");

    // ---------- Render ----------
    function faviconFor(url){
      try{
        const u = new URL(url);
        return "https://www.google.com/s2/favicons?domain=" + u.hostname;
      }catch{ return ""; }
    }

    function render(){
      stream.innerHTML = "";
      const items = getAll();
      for(const m of items){
        const card = document.createElement("article");
        card.className = "card" + (m.author === me.name ? " me" : "");
        card.dataset.id = m.id;

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = (m.author || "U")[0].toUpperCase();

        const msg = document.createElement("div");
        msg.className = "msg";

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.innerHTML = `<strong>${escapeHtml(m.author || "Unknown")}</strong><span>•</span><span>${timeStr(m.time)}</span>`;

        const body = document.createElement("div");
        body.className = "body";
        body.innerHTML = autoLink(m.text || "");

        const atts = document.createElement("div");
        atts.className = "attachments";

        // Links
        for(const url of (m.links||[])){
          const card = document.createElement("a");
          card.className = "link-card";
          card.href = url; card.target="_blank"; card.rel="noopener";
          const ico = document.createElement("img");
          ico.src = faviconFor(url); ico.alt="";
          const span = document.createElement("span");
          span.style.overflow="hidden"; span.style.whiteSpace="nowrap"; span.style.textOverflow="ellipsis";
          span.textContent = url;
          card.appendChild(ico); card.appendChild(span);
          atts.appendChild(card);
        }
        // Images
        for(const src of (m.images||[])){
          const t = document.createElement("a");
          t.className = "thumb";
          t.href = src; t.target="_blank"; t.rel="noopener";
          const img = document.createElement("img");
          img.src = src; img.alt="Image";
          t.appendChild(img);
          atts.appendChild(t);
        }

        const rowTop = document.createElement("div");
        rowTop.style.display="flex"; rowTop.style.alignItems="center"; rowTop.style.gap="8px";
        rowTop.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "actions";
        const del = document.createElement("button");
        del.className = "icon-btn"; del.textContent = "Delete";
        del.addEventListener("click", ()=> removeMessage(m.id));
        actions.appendChild(del);
        rowTop.appendChild(actions);

        msg.appendChild(rowTop);
        if((m.text||"").trim()) msg.appendChild(body);
        if(atts.children.length) msg.appendChild(atts);

        card.appendChild(avatar);
        card.appendChild(msg);
        stream.appendChild(card);
      }
      stream.scrollTop = stream.scrollHeight;
    }

    function removeMessage(id){
      const items = getAll().filter(x=>x.id!==id);
      saveAll(items); render();
    }

    // ---------- Previews (pending attachments) ----------
    function refreshPreviews(){
      previews.innerHTML = "";
      // link chips
      pending.links.forEach((u,i)=>{
        const chip = document.createElement("div");
        chip.className="chip";
        chip.innerHTML = `<img src="${faviconFor(u)}" alt="" style="width:14px;height:14px;border-radius:3px"> <span>${u}</span>`;
        const x = document.createElement("button"); x.textContent="✕";
        x.title="Remove link"; x.addEventListener("click",()=>{ pending.links.splice(i,1); refreshPreviews(); });
        chip.appendChild(x);
        previews.appendChild(chip);
      });
      // image thumb chips
      pending.images.forEach((src,i)=>{
        const chip = document.createElement("div");
        chip.className="chip";
        chip.innerHTML = `<span>Image ${i+1}</span>`;
        const x = document.createElement("button"); x.textContent="✕";
        x.title="Remove image"; x.addEventListener("click",()=>{ pending.images.splice(i,1); refreshPreviews(); });
        chip.appendChild(x);
        previews.appendChild(chip);
      });
    }

    // ---------- Compose handlers ----------
    addLinkBtn.addEventListener("click", ()=>{
      linkRow.style.display="grid";
      linkInput.focus();
    });
    cancelLink.addEventListener("click", ()=>{
      linkRow.style.display="none";
      linkInput.value="";
    });
    attachLink.addEventListener("click", ()=>{
      const v = (linkInput.value||"").trim();
      try{
        const u = new URL(v);
        if(!/^https?:$/.test(u.protocol)) return;
        pending.links.push(u.toString());
        linkInput.value=""; linkRow.style.display="none";
        refreshPreviews();
      }catch(_){}
    });

    file.addEventListener("change", async (e)=>{
      const files=[...e.target.files];
      for(const f of files){
        if(f.type.startsWith("image/")){
          const dataUrl = await readAndMaybeResize(f);
          pending.images.push(dataUrl);
        }
      }
      file.value="";
      refreshPreviews();
    });

    // Drag & drop for links/images
    ;["dragover","dragenter"].forEach(ev=>{
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.add("dragging"); });
    });
    ;["dragleave","drop"].forEach(ev=>{
      drop.addEventListener(ev, e=>{ e.preventDefault(); drop.classList.remove("dragging"); });
    });
    drop.addEventListener("drop", async (e)=>{
      // Images
      const files=[...(e.dataTransfer.files||[])];
      for(const f of files){
        if(f.type.startsWith("image/")){
          const dataUrl = await readAndMaybeResize(f);
          pending.images.push(dataUrl);
        }
      }
      // URLs (from dragged link/text)
      const textData = e.dataTransfer.getData("text/uri-list") || e.dataTransfer.getData("text/plain");
      if(textData){
        // Collect all http(s) URLs
        const urls = textData.match(/https?:\/\/\S+/g) || [];
        urls.forEach(u=>{
          try{ const v = new URL(u); if(/^https?:$/.test(v.protocol)) pending.links.push(v.toString()); }catch(_){}
        });
      }
      refreshPreviews();
    });

    // Enter to send (Shift+Enter for newline)
    text.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && !e.shiftKey){
        e.preventDefault(); send();
      }
    });
    form.addEventListener("submit", (e)=>{ e.preventDefault(); send(); });

    function send(){
      const content = (text.value||"").trim();
      if(!content && pending.links.length===0 && pending.images.length===0){
        // nothing to send
        return;
      }
      const msg = {
        id: crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random().toString(36).slice(2)),
        author: me.name || "You",
        text: content,
        links: [...pending.links],
        images: [...pending.images],
        time: Date.now()
      };
      const items = getAll(); items.push(msg); saveAll(items);
      // reset
      text.value=""; pending.links.length=0; pending.images.length=0;
      refreshPreviews(); render();
    }

    // Initial render
    render();
  </script>
</body>
</html>
